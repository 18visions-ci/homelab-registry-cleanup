---
- name: Run Docker Registry GC
  hosts: registry-node
  become: yes
  become_method: sudo  # Explicitly set sudo
  become_user: root  # Run as root
  tasks:
    - name: Run garbage collection script
      ansible.builtin.command: /usr/local/bin/prune_docker_registry.sh
      register: gc_output

    - name: Format Discord message body
      set_fact:
        discord_message: |
          ðŸ§¹ Docker Registry GC Output:
          ```
          {{ gc_output.stdout | default('No output') | truncate(1800, True, '...') }}
          ```

    - name: Send output to Discord
      uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: "{{ { 'content': discord_message } | to_json }}"
        body_format: json
        status_code: [200, 204]


