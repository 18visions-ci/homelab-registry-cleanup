---
- name: Run Docker Registry GC
  hosts: registry-node
  become: yes
  become_method: sudo  # Explicitly set sudo
  become_user: root  # Run as root
  tasks:
    - name: Run garbage collection script
      ansible.builtin.command: /usr/local/bin/prune_docker_registry.sh
      register: gc_output

    - name: Send output to Discord
      uri:
        url: "{{ discord_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: >
          {{
            {
              "content": "ðŸ§¹ Docker Registry GC Output:\n```\n" + (gc_output.stdout | default('No output') | truncate(1800, True, '...')) + "\n```"
            } | to_json
          }}
        body_format: json
        status_code: [200, 204]  # âœ… Accept either 200 OK or 204 No Content
